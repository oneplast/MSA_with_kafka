<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://js.tosspayments.com/v2/standard"></script>
</head>
<body>
<div class="box_section" style="padding: 40px 30px 50px 30px; margin-top: 30px; margin-bottom: 50px">
    <!-- 결제 UI -->
    <div id="payment-method"></div>
    <!-- 이용약관 UI -->
    <div id="agreement"></div>
    <!-- 결제하기 버튼 -->
    <div class="result wrapper">
        <button class="button" id="payment-button" style="margin-top: 30px">
            결제하기
        </button>
    </div>
</div>
<script th:inline="javascript">
    main();

    async function main() {

        // const urlParams = location.url.searchParams;

        const accountCode = [[ ${accountCode} ]];

        const button = document.getElementById("payment-button");

        const amount = {
            currency: "KRW",
            value: [[ ${description.totalPrice} ]],
        };

        // ------  결제위젯 초기화 ------
        const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
        // const customerKey = generateRandomString();
        const tossPayments = TossPayments(clientKey);

        // 회원 결제
        const widgets = tossPayments.widgets({
            "customerKey": accountCode,
        });

        await widgets.setAmount(amount);
        await widgets.renderPaymentMethods({
            selector: "#payment-method",
            variantKey: "DEFAULT",
        });

        await widgets.renderAgreement({selector: "#agreement", variantKey: "AGREEMENT"});

        button.addEventListener("click", async function () {
            // 결제를 요청하기 전에 orderId, amount를 서버에 저장하세요.
            // 결제 과정에서 악의적으로 결제 금액이 바뀌는 것을 확인하는 용도입니다.

            const cartItems = [[ ${description.items} ]];
            const cartItemCodes = cartItems.map(cartItem => cartItem.code);

            await fetch("/orders" , {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    cartItemCodes
                }),
            })
            .then(response => response.json())
            .then(data => {

                widgets.requestPayment({
                    orderId: data.data.orderCode,
                    orderName: data.data.orderItems[0].productName, // 이름 만드는 메서드는 추가
                    successUrl: window.location.origin + "/view/payments/success",
                    failUrl: window.location.origin + "/view/payments/fail",
                })

            })
            .catch(error => {
                console.error('Error:', error);
            }
            )

        });
    }

</script>
</body>
</html>